<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status - SkyBin</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 24px; }
        .status-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .status-card h3 { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; font-size: 14px; color: var(--text-primary); }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; }
        .status-indicator.online { background: #00ff88; box-shadow: 0 0 8px rgba(0, 255, 136, 0.5); }
        .status-indicator.offline { background: #ff4444; box-shadow: 0 0 8px rgba(255, 68, 68, 0.5); }
        .status-indicator.degraded { background: #ffaa00; box-shadow: 0 0 8px rgba(255, 170, 0, 0.5); }
        .status-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .status-detail:last-child { border-bottom: none; }
        .status-detail .label { color: var(--text-muted); }
        .status-detail .value { color: var(--text-primary); font-family: var(--font-mono); }
        .uptime-bar { height: 24px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin: 16px 0; display: flex; }
        .uptime-segment { height: 100%; min-width: 2px; margin-right: 1px; }
        .uptime-segment.up { background: #00ff88; }
        .uptime-segment.down { background: #ff4444; }
        .source-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
        .source-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg-primary); border-radius: 6px; }
        .source-name { color: var(--text-primary); font-size: 13px; }
        .source-status { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .source-status.active { color: #00ff88; }
        .source-status.idle { color: var(--text-muted); }
        .header-status { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .header-status .big-indicator { width: 16px; height: 16px; border-radius: 50%; }
        .header-status .big-indicator.online { background: #00ff88; box-shadow: 0 0 12px rgba(0, 255, 136, 0.6); }
        .overall-status { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .last-updated { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">SkyBin <span>v1.6.2</span></a>
            <ul class="nav-links">
                <li><a href="/">Feed</a></li>
                <li><a href="/search">Search</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/changelog">Changelog</a></li>
                <li><a href="/status" class="active">Status</a></li>
            </ul>
            <a href="/upload" class="btn btn-primary btn-sm">New Paste</a>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <div class="page-header">
                <div class="header-status">
                    <div class="big-indicator online" id="overall-indicator"></div>
                    <span class="overall-status" id="overall-text">All Systems Operational</span>
                </div>
                <p>Real-time status of SkyBin services and sources</p>
                <div class="last-updated">Last checked: <span id="last-check">-</span></div>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <h3><span class="status-indicator online" id="api-indicator"></span>API Server</h3>
                    <div class="status-detail">
                        <span class="label">Status</span>
                        <span class="value" id="api-status">Online</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Response Time</span>
                        <span class="value" id="api-latency">-</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Version</span>
                        <span class="value">v1.3.1</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3><span class="status-indicator online" id="db-indicator"></span>Database</h3>
                    <div class="status-detail">
                        <span class="label">Status</span>
                        <span class="value" id="db-status">Online</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Total Pastes</span>
                        <span class="value" id="db-pastes">-</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Storage</span>
                        <span class="value" id="db-size">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3><span class="status-indicator online" id="scraper-indicator"></span>Scraper Engine</h3>
                    <div class="status-detail">
                        <span class="label">Status</span>
                        <span class="value" id="scraper-status">Running</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Active Sources</span>
                        <span class="value" id="scraper-sources">-</span>
                    </div>
                    <div class="status-detail">
                        <span class="label">Last Scrape</span>
                        <span class="value" id="last-scrape">-</span>
                    </div>
                </div>
            </div>

            <div class="status-card" style="margin-top: 24px;">
                <h3><span class="status-indicator online"></span>Paste Sources (24 Total)</h3>
                <div class="source-list" id="source-list">
                    Loading sources...
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>Made with ❤ by <a href="https://github.com/NullMeDev" target="_blank">NullMeDev</a></div>
                <ul class="footer-links">
                    <li><a href="/status">Status</a></li>
                    <li><a href="https://github.com/NullMeDev/skybin" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = '/api';
        
        const allSources = [
            { name: 'pastebin', label: 'Pastebin' },
            { name: 'gists', label: 'GitHub Gists' },
            { name: 'ideone', label: 'Ideone' },
            { name: 'paste_ee', label: 'Paste.ee' },
            { name: 'rentry', label: 'Rentry' },
            { name: 'dpaste', label: 'dpaste' },
            { name: 'hastebin', label: 'Hastebin' },
            { name: 'slexy', label: 'Slexy' },
            { name: 'ubuntu_pastebin', label: 'Ubuntu Pastebin' },
            { name: 'ixio', label: 'ix.io' },
            { name: 'justpaste', label: 'JustPaste' },
            { name: 'controlc', label: 'ControlC' },
            { name: 'pastecode', label: 'Pastecode' },
            { name: 'dpaste_org', label: 'dpaste.org' },
            { name: 'defuse', label: 'Defuse' },
            { name: 'codepad', label: 'Codepad' },
            { name: 'bpaste', label: 'bpaste' },
            { name: 'termbin', label: 'Termbin' },
            { name: 'sprunge', label: 'Sprunge' },
            { name: 'paste_rs', label: 'paste.rs' },
            { name: 'paste2', label: 'Paste2' },
            { name: 'pastebin_pl', label: 'Pastebin.pl' },
            { name: 'quickpaste', label: 'Quickpaste' },
            { name: 'ghostbin', label: 'Ghostbin' },
        ];

        async function checkStatus() {
            const start = Date.now();
            
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                const latency = Date.now() - start;
                
                document.getElementById('api-latency').textContent = `${latency}ms`;
                document.getElementById('api-status').textContent = 'Online';
                document.getElementById('api-indicator').classList.remove('offline');
                document.getElementById('api-indicator').classList.add('online');
                
                // Database status - checks for 'connected' not 'ok'
                if (data.database === 'connected') {
                    document.getElementById('db-status').textContent = 'Online';
                    document.getElementById('db-indicator').classList.remove('offline');
                    document.getElementById('db-indicator').classList.add('online');
                } else {
                    document.getElementById('db-status').textContent = 'Offline';
                    document.getElementById('db-indicator').classList.remove('online');
                    document.getElementById('db-indicator').classList.add('offline');
                }
                
            } catch (e) {
                document.getElementById('api-status').textContent = 'Offline';
                document.getElementById('api-indicator').classList.remove('online');
                document.getElementById('api-indicator').classList.add('offline');
                document.getElementById('overall-text').textContent = 'Service Disruption';
                document.getElementById('overall-indicator').classList.remove('online');
                document.getElementById('overall-indicator').classList.add('offline');
            }
            
            document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                
                if (data.success && data.data) {
                    document.getElementById('db-pastes').textContent = data.data.total.toLocaleString();
                    document.getElementById('scraper-sources').textContent = Object.keys(data.data.by_source || {}).length + ' active';
                    
                    // Render source list with activity
                    const sourceList = document.getElementById('source-list');
                    sourceList.innerHTML = allSources.map(s => {
                        const count = (data.data.by_source && data.data.by_source[s.name]) || 0;
                        const isActive = count > 0;
                        return `
                            <div class="source-item">
                                <span class="source-name">${s.label}</span>
                                <span class="source-status ${isActive ? 'active' : 'idle'}">
                                    <span style="font-size: 8px;">●</span>
                                    ${isActive ? `${count.toLocaleString()} pastes` : 'Idle'}
                                </span>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Initial load
        checkStatus();
        loadStats();

        // Auto-refresh every 30 seconds
        setInterval(checkStatus, 30000);
        setInterval(loadStats, 60000);
    </script>
</body>
</html>
