<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyBin</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">SkyBin <span>v1.3.1</span></a>
            <ul class="nav-links">
                <li><a href="/" class="active">Feed</a></li>
                <li><a href="/search">Search</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/changelog">Changelog</a></li>
                <li><a href="https://github.com/NullMeDev/skybin" target="_blank">GitHub</a></li>
            </ul>
            <a href="/upload" class="btn btn-primary btn-sm">New Paste</a>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <div class="page-header">
                <h1>Paste Feed</h1>
                <p>Real-time aggregation from public paste sites</p>
            </div>

            <div class="stats-bar" id="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="stat-total">--</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-sensitive">--</div>
                    <div class="stat-label">Sensitive</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-recent">--</div>
                    <div class="stat-label">Last 24h</div>
                </div>
                <div class="stat" id="sources-stat" style="cursor: pointer;" onclick="toggleSourcesModal()">
                    <div class="stat-value" id="stat-sources">--</div>
                    <div class="stat-label">Sources ‚ñº</div>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="interesting" style="background: linear-gradient(135deg, #f39c12, #e74c3c);">üî• Interesting</button>
                <button class="filter-btn" data-filter="sensitive">Sensitive Only</button>
                <button class="filter-btn" data-filter="pastebin">Pastebin</button>
                <button class="filter-btn" data-filter="gists">Gists</button>
                <button class="filter-btn" data-filter="ideone">Ideone</button>
            </div>

            <div id="paste-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading pastes...
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button id="prev-btn" disabled>Previous</button>
                <button id="next-btn">Next</button>
            </div>
        </div>
    </main>

    <!-- Sources Modal -->
    <div id="sources-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 70vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: var(--text-primary);">Source Status</h3>
                <button onclick="toggleSourcesModal()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div id="sources-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div style="display: flex; align-items: center; gap: 8px;">Made with <span style="color: #ff6b6b;">‚ù§</span> by <a href="https://github.com/NullMeDev" target="_blank" style="color: var(--primary);">NullMeDev</a></div>
                <ul class="footer-links">
                    <li><a href="/status">Status</a></li>
                    <li><a href="https://github.com/NullMeDev/skybin" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = '/api';
        let currentPage = 0;
        let currentFilter = 'all';
        const LIMIT = 25;

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('stat-total').textContent = data.data.total_pastes.toLocaleString();
                    document.getElementById('stat-sensitive').textContent = data.data.sensitive_pastes.toLocaleString();
                    document.getElementById('stat-recent').textContent = data.data.recent_count.toLocaleString();
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadPastes() {
            const container = document.getElementById('paste-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading pastes...</div>';

            try {
                let url = `${API_BASE}/pastes?limit=${LIMIT}&offset=${currentPage * LIMIT}`;
                
                if (currentFilter === 'sensitive') {
                    url += '&sensitive=true';
                } else if (currentFilter === 'interesting') {
                    url += '&interesting=true';
                } else if (currentFilter !== 'all') {
                    url += `&source=${currentFilter}`;
                }

                const res = await fetch(url);
                const data = await res.json();

                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No pastes found</h3>
                            <p>Pastes will appear here as they are scraped from public sources.</p>
                        </div>
                    `;
                    document.getElementById('pagination').style.display = 'none';
                    return;
                }

                const html = data.data.map(paste => `
                    <a href="/paste/${paste.id}" class="paste-item">
                        <div class="paste-info">
                            <div class="paste-title">${escapeHtml(paste.title || 'Untitled')}</div>
                            <div class="paste-meta">
                                <span>${paste.syntax || 'plaintext'}</span>
                            </div>
                        </div>
                        <div class="paste-badges">
                            ${paste.is_sensitive ? '<span class="badge badge-sensitive">Sensitive</span>' : ''}
                            <span class="badge badge-source">${paste.source}</span>
                        </div>
                        <div class="paste-time">${formatTime(paste.created_at)}</div>
                    </a>
                `).join('');

                container.innerHTML = `<div class="paste-list">${html}</div>`;
                
                // Show pagination
                const pagination = document.getElementById('pagination');
                pagination.style.display = 'flex';
                document.getElementById('prev-btn').disabled = currentPage === 0;
                document.getElementById('next-btn').disabled = data.data.length < LIMIT;

            } catch (e) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Failed to load pastes</h3>
                        <p>Could not connect to the API. Make sure the server is running.</p>
                        <button class="btn btn-secondary" onclick="loadPastes()">Retry</button>
                    </div>
                `;
            }
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                currentPage = 0;
                loadPastes();
            });
        });

        // Pagination
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                loadPastes();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            currentPage++;
            loadPastes();
        });

        // Sources data
        const allSources = [
            { name: 'pastebin', label: 'Pastebin' },
            { name: 'gists', label: 'GitHub Gists' },
            { name: 'ideone', label: 'Ideone' },
            { name: 'paste_ee', label: 'Paste.ee' },
            { name: 'rentry', label: 'Rentry' },
            { name: 'dpaste', label: 'dpaste' },
            { name: 'hastebin', label: 'Hastebin' },
            { name: 'slexy', label: 'Slexy' },
            { name: 'ubuntu_pastebin', label: 'Ubuntu Pastebin' },
            { name: 'ixio', label: 'ix.io' },
            { name: 'justpaste', label: 'JustPaste' },
            { name: 'controlc', label: 'ControlC' },
            { name: 'pastecode', label: 'Pastecode' },
            { name: 'dpaste_org', label: 'dpaste.org' },
            { name: 'defuse', label: 'Defuse' },
            { name: 'codepad', label: 'Codepad' },
            { name: 'bpaste', label: 'bpaste' },
            { name: 'termbin', label: 'Termbin' },
            { name: 'sprunge', label: 'Sprunge' },
            { name: 'paste_rs', label: 'paste.rs' },
            { name: 'paste2', label: 'Paste2' },
            { name: 'pastebin_pl', label: 'Pastebin.pl' },
            { name: 'quickpaste', label: 'Quickpaste' },
            { name: 'ghostbin', label: 'Ghostbin' },
        ];
        let sourcesStatus = {};

        async function loadSourcesStatus() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                // For now, assume all sources enabled are "up"
                const sourceCount = allSources.length;
                document.getElementById('stat-sources').textContent = sourceCount;
                
                // Mark sources based on recent activity
                const statsRes = await fetch(`${API_BASE}/stats`);
                const statsData = await statsRes.json();
                if (statsData.success && statsData.data.by_source) {
                    allSources.forEach(s => {
                        sourcesStatus[s.name] = statsData.data.by_source[s.name] > 0 ? 'active' : 'idle';
                    });
                }
            } catch (e) {
                document.getElementById('stat-sources').textContent = allSources.length;
            }
        }

        function toggleSourcesModal() {
            const modal = document.getElementById('sources-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                renderSourcesList();
            }
        }

        function renderSourcesList() {
            const list = document.getElementById('sources-list');
            list.innerHTML = allSources.map(s => {
                const status = sourcesStatus[s.name] || 'idle';
                const color = status === 'active' ? '#00ff88' : '#888';
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px;">
                        <span style="color: var(--text-primary);">${s.label}</span>
                        <span style="color: ${color}; font-size: 12px;">‚óè ${status === 'active' ? 'Active' : 'Idle'}</span>
                    </div>
                `;
            }).join('');
        }

        // Close modal on outside click
        document.getElementById('sources-modal').addEventListener('click', (e) => {
            if (e.target.id === 'sources-modal') toggleSourcesModal();
        });

        // Initial load
        loadStats();
        loadPastes();
        loadSourcesStatus();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadSourcesStatus();
            if (currentPage === 0) loadPastes();
        }, 30000);
    </script>
</body>
</html>
