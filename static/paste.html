<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paste - SkyBin</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .export-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .comments-section { margin-top: 24px; }
        .comments-section h3 { margin-bottom: 16px; color: var(--text-primary); }
        .comment-form { display: flex; gap: 8px; margin-bottom: 16px; }
        .comment-form textarea { flex: 1; min-height: 60px; resize: vertical; }
        .comment-list { display: flex; flex-direction: column; gap: 12px; }
        .comment { background: var(--bg-secondary); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .comment-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .comment-content { color: var(--text-primary); white-space: pre-wrap; word-break: break-word; }
        .no-comments { color: var(--text-muted); font-style: italic; }
        .reply-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; margin-top: 8px; }
        .reply-btn:hover { color: var(--primary); }
        .reply-form { display: none; margin-top: 8px; }
        .reply-form.active { display: flex; gap: 8px; }
        .reply-form textarea { flex: 1; min-height: 40px; font-size: 13px; }
        .replies { margin-left: 24px; margin-top: 8px; border-left: 2px solid var(--border); padding-left: 12px; }
        .reply { background: var(--bg-primary); padding: 8px; border-radius: 4px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <nav>
        <div class="container">
<a href="/" class="logo">SkyBin <span>v2.1.0</span></a>
            <ul class="nav-links">
                <li><a href="/">Feed</a></li>
                <li><a href="/search">Search</a></li>
                <li><a href="/upload">Upload</a></li>
                <li><a href="/changelog">Changelog</a></li>
                <li><a href="/status">Status</a></li>
            </ul>
            <a href="/upload" class="btn btn-primary btn-sm">New Paste</a>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <div id="paste-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading paste...
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>Made with ‚ù§ by <a href="https://github.com/NullMeDev" target="_blank">NullMeDev</a></div>
                <ul class="footer-links">
                    <li><a href="/status">Status</a></li>
                    <li><a href="https://github.com/NullMeDev/skybin" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <div class="toast" id="toast"></div>

    <script>
        function getPasteId() {
            const path = window.location.pathname;
            const match = path.match(/\/paste\/([a-f0-9-]+)/);
            return match ? match[1] : null;
        }

        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getSeverityClass(severity) {
            const map = {
                'critical': 'badge-critical',
                'high': 'badge-high',
                'moderate': 'badge-moderate',
                'low': 'badge-low'
            };
            return map[severity] || 'badge-source';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard');
            } catch (e) {
                showToast('Failed to copy', 'error');
            }
        }

        async function loadPaste() {
            const container = document.getElementById('paste-container');
            const pasteId = getPasteId();

            if (!pasteId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Invalid paste ID</h3>
                        <p>The paste you're looking for doesn't exist.</p>
                        <a href="/" class="btn btn-secondary">Back to Feed</a>
                    </div>
                `;
                return;
            }

            try {
                const res = await fetch(`/api/paste/${pasteId}`);
                const data = await res.json();

                if (!data.success || !data.data) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Paste not found</h3>
                            <p>This paste may have been deleted or expired.</p>
                            <a href="/" class="btn btn-secondary">Back to Feed</a>
                        </div>
                    `;
                    return;
                }

                const paste = data.data;
                document.title = `${paste.title || 'Untitled'} - SkyBin`;

                let patternsHtml = '';
                if (paste.matched_patterns && paste.matched_patterns.length > 0) {
                    const patternTags = paste.matched_patterns.map(p => `
                        <div class="pattern-tag">
                            <span class="badge ${getSeverityClass(p.severity)}">${p.severity}</span>
                            ${escapeHtml(p.name)}
                        </div>
                    `).join('');
                    
                    patternsHtml = `
                        <div class="paste-patterns">
                            <h3>Detected Patterns</h3>
                            <div class="pattern-list">${patternTags}</div>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <a href="/" class="btn btn-secondary btn-sm">Back to Feed</a>
                    </div>
                    
                    <div class="paste-detail">
                        <div class="paste-detail-header">
                            <div>
                                <h1 class="paste-detail-title">${escapeHtml(paste.title || 'Untitled')}</h1>
                            <div class="paste-detail-meta">
                                    <span>Source: ${paste.source}</span>
                                    <span>Syntax: ${paste.syntax || 'plaintext'}</span>
                                    <span>Created: ${formatDate(paste.created_at)}</span>
                                    ${paste.high_value ? '<span class="badge badge-critical">üö® CRITICAL</span>' : ''}
                                    ${paste.is_sensitive && !paste.high_value ? '<span class="badge badge-sensitive">Sensitive</span>' : ''}
                                </div>
                            </div>
                            <div class="paste-detail-actions">
                                <button class="btn btn-secondary btn-sm" onclick="copyToClipboard(document.getElementById('paste-content').textContent)">
                                    Copy
                                </button>
                                <a href="/raw/${paste.id}" class="btn btn-secondary btn-sm" target="_blank">
                                    Raw
                                </a>
                            </div>
                        </div>
                        <div class="export-buttons">
                            <a href="/api/export/${paste.id}/json" class="btn btn-secondary btn-sm" download>Export JSON</a>
                            <a href="/api/export/${paste.id}/csv" class="btn btn-secondary btn-sm" download>Export CSV</a>
                        </div>
                        <pre class="paste-content" id="paste-content">${escapeHtml(paste.content)}</pre>
                        ${patternsHtml}
                        
                        <div class="comments-section">
                            <h3>Comments</h3>
                            <div class="comment-form">
                                <textarea id="comment-input" placeholder="Add an anonymous comment..." maxlength="2000"></textarea>
                                <button class="btn btn-primary btn-sm" onclick="submitComment()">Post</button>
                            </div>
                            <div class="comment-list" id="comments-list">
                                <div class="loading"><div class="spinner"></div>Loading comments...</div>
                            </div>
                        </div>
                    </div>
                `;
                loadComments(pasteId);

            } catch (e) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Failed to load paste</h3>
                        <p>Could not connect to the API.</p>
                        <button class="btn btn-secondary" onclick="loadPaste()">Retry</button>
                    </div>
                `;
            }
        }

        async function loadComments(pasteId) {
            const container = document.getElementById('comments-list');
            try {
                const res = await fetch(`/api/paste/${pasteId}/comments`);
                const data = await res.json();
                if (data.success && data.data) {
                    if (data.data.length === 0) {
                        container.innerHTML = '<div class="no-comments">No comments yet. Be the first to comment!</div>';
                    } else {
                        // Separate top-level comments and replies
                        const topLevel = data.data.filter(c => !c.parent_id);
                        const replies = data.data.filter(c => c.parent_id);
                        
                        container.innerHTML = topLevel.map(c => {
                            const commentReplies = replies.filter(r => r.parent_id === c.id);
                            const repliesHtml = commentReplies.length > 0 ? `
                                <div class="replies">
                                    ${commentReplies.map(r => `
                                        <div class="reply">
                                            <div class="comment-meta">Anonymous ‚Ä¢ ${formatDate(r.created_at)}</div>
                                            <div class="comment-content">${escapeHtml(r.content)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '';
                            return `
                                <div class="comment" data-id="${c.id}">
                                    <div class="comment-meta">Anonymous ‚Ä¢ ${formatDate(c.created_at)}</div>
                                    <div class="comment-content">${escapeHtml(c.content)}</div>
                                    <button class="reply-btn" onclick="toggleReply('${c.id}')">‚Ü© Reply</button>
                                    <div class="reply-form" id="reply-form-${c.id}">
                                        <textarea id="reply-input-${c.id}" placeholder="Write a reply..." maxlength="2000"></textarea>
                                        <button class="btn btn-primary btn-sm" onclick="submitReply('${c.id}')">Reply</button>
                                    </div>
                                    ${repliesHtml}
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                container.innerHTML = '<div class="no-comments">Failed to load comments</div>';
            }
        }

        function toggleReply(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.classList.toggle('active');
        }

        async function submitReply(parentId) {
            const input = document.getElementById(`reply-input-${parentId}`);
            const content = input.value.trim();
            if (!content) {
                showToast('Reply cannot be empty', 'error');
                return;
            }
            const pasteId = getPasteId();
            try {
                const res = await fetch(`/api/paste/${pasteId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, parent_id: parentId })
                });
                const data = await res.json();
                if (data.success) {
                    input.value = '';
                    showToast('Reply posted!');
                    loadComments(pasteId);
                } else {
                    showToast(data.error || 'Failed to post reply', 'error');
                }
            } catch (e) {
                showToast('Failed to post reply', 'error');
            }
        }

        async function submitComment() {
            const input = document.getElementById('comment-input');
            const content = input.value.trim();
            if (!content) {
                showToast('Comment cannot be empty', 'error');
                return;
            }
            const pasteId = getPasteId();
            try {
                const res = await fetch(`/api/paste/${pasteId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await res.json();
                if (data.success) {
                    input.value = '';
                    showToast('Comment posted!');
                    loadComments(pasteId);
                } else {
                    showToast(data.error || 'Failed to post comment', 'error');
                }
            } catch (e) {
                showToast('Failed to post comment', 'error');
            }
        }

        loadPaste();
    </script>
</body>
</html>
