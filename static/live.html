<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Feed - SkyBin</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .live-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .live-indicator {
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .live-indicator.connected {
            background: #22c55e;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-status {
            font-size: 13px;
            color: var(--text-muted);
        }
        .feed-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .control-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .control-btn:hover {
            background: var(--bg-hover);
        }
        .control-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .feed-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-muted);
        }
        .feed-stats span {
            font-weight: 600;
            color: var(--text-primary);
        }
        .live-feed {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            background: var(--bg-secondary);
        }
        .feed-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .feed-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .feed-item-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        .feed-item-meta {
            display: flex;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .feed-item-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">SkyBin <span>v2.5.0</span></a>
            <ul class="nav-links">
                <li><a href="/">Feed</a></li>
                <li><a href="/search">Search</a></li>
                <li><a href="/live" class="active">Live</a></li>
                <li><a href="/changelog">Changelog</a></li>
                <li><a href="/status">Status</a></li>
            </ul>
            <a href="/upload" class="btn btn-primary btn-sm">New Paste</a>
        </div>
    </nav>

    <main class="page">
        <div class="container">
            <div class="page-header">
                <div class="live-header">
                    <h1>üì° Live Feed</h1>
                    <div class="live-indicator" id="status-indicator"></div>
                    <div class="connection-status" id="connection-status">Connecting...</div>
                </div>
                <p>Real-time paste stream via WebSocket</p>
            </div>

            <!-- Filters -->
            <div class="feed-controls">
                <button class="control-btn active" data-filter="all">All</button>
                <button class="control-btn" data-filter="sensitive">Sensitive Only</button>
                <button class="control-btn" data-filter="high_value">Critical Only</button>
                <button class="control-btn" id="pause-btn">‚è∏ Pause</button>
                <button class="control-btn" id="clear-btn">üóë Clear</button>
            </div>

            <!-- Stats -->
            <div class="feed-stats">
                <div>Received: <span id="stat-total">0</span></div>
                <div>Sensitive: <span id="stat-sensitive">0</span></div>
                <div>Critical: <span id="stat-critical">0</span></div>
                <div>Connection: <span id="stat-uptime">0s</span></div>
            </div>

            <!-- Feed -->
            <div class="live-feed" id="live-feed">
                <div class="empty-state">
                    <h3>Waiting for pastes...</h3>
                    <p>Live stream will appear here once connected.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Sound Toggle -->
    <button class="sound-toggle" id="sound-toggle">üîá Sound Off</button>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>Made with ‚ù§ by <a href="https://github.com/NullMeDev" target="_blank">NullMeDev</a></div>
                <ul class="footer-links">
                    <li><a href="/status">Status</a></li>
                    <li><a href="https://github.com/NullMeDev/skybin" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script>
        let ws = null;
        let isPaused = false;
        let soundEnabled = false;
        let currentFilter = 'all';
        let stats = { total: 0, sensitive: 0, critical: 0, uptime: 0 };
        let connectionTime = null;
        const MAX_ITEMS = 100;

        // Audio notification
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (!soundEnabled) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('status-indicator').classList.add('connected');
                document.getElementById('connection-status').textContent = 'Connected';
                connectionTime = Date.now();
            };

            ws.onmessage = (event) => {
                if (isPaused) return;

                try {
                    const data = JSON.parse(event.data);
                    handleEvent(data);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('connection-status').textContent = 'Error';
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('status-indicator').classList.remove('connected');
                document.getElementById('connection-status').textContent = 'Disconnected';
                
                // Reconnect after 3s
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleEvent(event) {
            if (event.type === 'PasteAdded') {
                handlePasteAdded(event);
            } else if (event.type === 'StatsUpdate') {
                // Could update global stats here
            }
        }

        function handlePasteAdded(paste) {
            // Update stats
            stats.total++;
            if (paste.is_sensitive) stats.sensitive++;
            if (paste.high_value) stats.critical++;
            updateStats();

            // Apply filter
            if (currentFilter === 'sensitive' && !paste.is_sensitive) return;
            if (currentFilter === 'high_value' && !paste.high_value) return;

            // Play sound for high-value alerts
            if (paste.high_value) {
                playBeep();
            }

            // Add to feed
            const feed = document.getElementById('live-feed');
            
            // Remove empty state if present
            const emptyState = feed.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const item = document.createElement('div');
            item.className = 'feed-item';
            if (paste.high_value) item.style.borderColor = '#ef4444';

            const badges = [];
            if (paste.high_value) badges.push('<span class="badge badge-critical">üö® CRITICAL</span>');
            else if (paste.is_sensitive) badges.push('<span class="badge badge-sensitive">Sensitive</span>');
            badges.push(`<span class="badge badge-source">${paste.source}</span>`);

            item.innerHTML = `
                <div class="feed-item-header">
                    <div class="feed-item-title">${paste.title || 'Untitled'}</div>
                    <div>${badges.join(' ')}</div>
                </div>
                <div class="feed-item-meta">
                    <span>ID: ${paste.id.substring(0, 8)}</span>
                    <span>Syntax: ${paste.syntax}</span>
                    <span>${formatTime(paste.created_at)}</span>
                </div>
                <div class="feed-item-preview">${escapeHtml(paste.preview)}</div>
                <a href="/paste/${paste.id}" class="btn btn-sm btn-secondary">View Full Paste ‚Üí</a>
            `;

            feed.insertBefore(item, feed.firstChild);

            // Limit items
            const items = feed.querySelectorAll('.feed-item');
            if (items.length > MAX_ITEMS) {
                items[items.length - 1].remove();
            }
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-sensitive').textContent = stats.sensitive;
            document.getElementById('stat-critical').textContent = stats.critical;
        }

        function formatTime(ts) {
            const d = new Date(ts * 1000);
            const now = new Date();
            const diff = Math.floor((now - d) / 1000);
            if (diff < 10) return 'just now';
            if (diff < 60) return diff + 's ago';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            return Math.floor(diff / 3600) + 'h ago';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
            });
        });

        document.getElementById('pause-btn').addEventListener('click', (e) => {
            isPaused = !isPaused;
            e.target.textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
            e.target.classList.toggle('active', isPaused);
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            document.getElementById('live-feed').innerHTML = `
                <div class="empty-state">
                    <h3>Feed cleared</h3>
                    <p>New pastes will appear here.</p>
                </div>
            `;
        });

        document.getElementById('sound-toggle').addEventListener('click', (e) => {
            soundEnabled = !soundEnabled;
            e.target.textContent = soundEnabled ? 'üîä Sound On' : 'üîá Sound Off';
        });

        // Update uptime
        setInterval(() => {
            if (connectionTime) {
                const uptime = Math.floor((Date.now() - connectionTime) / 1000);
                document.getElementById('stat-uptime').textContent = uptime + 's';
            }
        }, 1000);

        // Connect on load
        connectWebSocket();
    </script>
</body>
</html>
