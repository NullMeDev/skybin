{% extends "base.html" %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid" id="stats-grid">
    <div class="stat-card">
        <h3>Total Pastes</h3>
        <div class="value" id="stat-total">--</div>
    </div>
    <div class="stat-card danger">
        <h3>Sensitive</h3>
        <div class="value" id="stat-sensitive">--</div>
    </div>
    <div class="stat-card success">
        <h3>Last 24h</h3>
        <div class="value" id="stat-recent">--</div>
    </div>
    <div class="stat-card warning">
        <h3>Sources Active</h3>
        <div class="value" id="stat-sources">--</div>
    </div>
</div>

<div class="content-card">
    <h3>Recent Pastes</h3>
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Language</th>
                    <th>Source</th>
                    <th>Sensitive</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody id="recent-tbody">
                <tr>
                    <td colspan="5" style="text-align: center; color: #9ca3af;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Fetch statistics
    async function loadStatistics() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            if (data.success && data.data) {
                const stats = data.data;
                document.getElementById('stat-total').textContent = stats.total_pastes.toLocaleString();
                document.getElementById('stat-sensitive').textContent = stats.sensitive_pastes.toLocaleString();
                document.getElementById('stat-recent').textContent = stats.recent_count.toLocaleString();
                document.getElementById('stat-sources').textContent = Object.keys(stats.by_source).length;
            }
        } catch (error) {
            console.error('Failed to load statistics:', error);
        }
    }

    // Fetch recent pastes
    async function loadRecentPastes() {
        try {
            const response = await fetch('/api/pastes');
            const data = await response.json();
            
            if (data.success && data.data) {
                const pastes = data.data.slice(0, 15);
                
                const pasteRows = pastes.map(paste => {
                    const date = new Date(paste.created_at * 1000).toLocaleString();
                    const title = paste.title || '(No Title)';
                    const language = paste.syntax || 'Plaintext';
                    const sensitiveIcon = paste.is_sensitive ? '<span class="badge badge-danger">⚠️</span>' : '<span class="badge badge-success">✓</span>';
                    
                    return `
                        <tr style="cursor: pointer;" onclick="window.location='/paste/${paste.id}'">
                            <td><a href="/paste/${paste.id}" style="color: inherit; text-decoration: none;">${escapeHtml(title)}</a></td>
                            <td>${escapeHtml(language)}</td>
                            <td><span class="badge badge-info">${escapeHtml(paste.source)}</span></td>
                            <td>${sensitiveIcon}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('recent-tbody').innerHTML = pasteRows || '<tr><td colspan="5" style="text-align: center; color: #9ca3af;">No pastes yet</td></tr>';
            }
        } catch (error) {
            console.error('Failed to load recent pastes:', error);
        }
    }
    
    // HTML escape helper
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load data on page load
    loadStatistics();
    loadRecentPastes();
    
    // Refresh every 30 seconds
    setInterval(() => {
        loadStatistics();
        loadRecentPastes();
    }, 30000);
</script>
{% endblock %}
